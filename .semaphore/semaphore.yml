version: v1.0
name: Python
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Setup
    task:
      jobs:
        - name: Setup
          matrix:
            - env_var: PYTHON_VERSION
              values:
                - '3.8'
                - '3.9'
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
    dependencies: []
  - name: Test
    skip:
      when: branch = 'master'
    task:
      jobs:
        - name: Check
          commands:
            - checkout
            - pip install poetry
            - poetry install
            - poetry run cover
    dependencies:
      - Setup
  - name: Deploy
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Publish
          commands:
            - checkout
            - pip install poetry
            - poetry install
            - poetry config http-basic.pypi $PYPI_USERNAME $PYPI_PASSWORD
            - poetry build -f sdist
            - poetry publish
      secrets:
        - name: PYPI
    dependencies:
      - Setup
