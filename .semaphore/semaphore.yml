version: v1.0
name: Python
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: setup
    skip:
      when: branch = 'master'
    task:
      jobs:
        - name: Check
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
          matrix:
            - env_var: PYTHON_VERSION
              values:
                - '3.8'
                - '3.9'
      env_vars: []
      secrets:
        - name: COVERALLS
    dependencies: []
  - name: Deploy
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Publish
          commands:
            - poetry run cover
            - poetry config http-basic.pypi $PYPI_USERNAME $PYPI_PASSWORD
            - poetry build -f sdist
            - poetry publish
      secrets:
        - name: PYPI
        - name: COVERALLS
      env_vars:
        - name: PYTHON_VERSION
          value: '3.8'
    dependencies:
      - setup
  - name: Test
    dependencies:
      - setup
    skip:
      when: branch = 'master'
    task:
      secrets:
        - name: COVERALLS
      jobs:
        - name: Check
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
            - poetry run cover
      env_vars:
        - name: PYTHON_VERSION
          value: '3.8'
