version: v1.0
name: Python
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test
    skip:
      when: branch = 'master'
    task:
      jobs:
        - name: Check
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
            - poetry run cover
      env_vars:
        - name: PYTHON_VERSION
          value: '3.8'
    dependencies: []
  - name: Deploy
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Publish
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
            - poetry config http-basic.pypi $PYPI_USERNAME $PYPI_PASSWORD
            - poetry build -f sdist
            - poetry publish
      secrets:
        - name: PYPI
      env_vars:
        - name: PYTHON_VERSION
          value: '3.8'
    dependencies: []
