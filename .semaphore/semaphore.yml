version: v1.0
name: Python
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Setup
    task:
      jobs:
        - name: installing things
          matrix:
            - env_vars: PYTHON_VERSION
              values:
                - '3.6'
                - '3.7'
                - '3.8'
                - '3.9'
          commands:
            - sem-version python $PYTHON_VERSION
            - checkout
            - pip install poetry
            - poetry install
  - name: Test
    skip:
      when: branch = 'master'
    task:
      jobs:
        - name: Test & Coverage
          commands:
            - poetry run cover
  - name: Deploy
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Nameless 1
          commands:
            - poetry config http-basic.pypi $PYPI_USERNAME $PYPI_PASSWORD
            - poetry build -f sdist
            - poetry publish
      secrets:
        - name: PYPI
